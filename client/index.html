<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMF Voice Agent</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1>SMF VOICE AGENT</h1>
            <div class="header-controls">
                <img src="/assets/kb.ico" alt="Knowledge Base" class="kb-icon header-icon" onclick="openFileManager()" title="Knowledge Base Manager">
                <img src="assets/people.ico" alt="People" class="header-icon people-icon" onclick="openPeopleModal()" title="Select Person">
                <img src="assets/settings.ico" alt="Settings" class="header-icon settings-icon" id="settings-btn" title="Settings">
                <div class="speaker-indicator">
                    <span id="current-speaker">No one selected</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Conversation Display -->
            <div class="conversation-display">
                <div id="transcript-container" class="transcript-container">
                    <div class="welcome-message">
                        <h2>Welcome!</h2>
                        <p>Start a conversation by speaking or typing below.</p>
                    </div>
                </div>
            </div>

            <!-- Response Selection -->
            <div class="response-selection" id="response-selection">
                <div class="response-header">
                    <h3>Choose your response:</h3>
                    <div class="response-actions">
                        <button id="cancel-responses-btn" class="response-action-btn cancel-btn">Cancel</button>
                        <button id="resend-responses-btn" class="response-action-btn resend-btn">Resend</button>
                    </div>
                </div>
                <div class="response-options" id="response-options">
                    <!-- Response options will be dynamically added here -->
                </div>
            </div>

            <!-- Input Controls -->
            <div class="input-controls">
                <div class="recording-indicator" id="recording-indicator">
                    <span class="pulse"></span>
                    <span>Listening...</span>
                </div>
                
                <div class="text-input-container">
                    <textarea 
                        id="text-input" 
                        class="text-input" 
                        placeholder="Type your message here..."
                        rows="3"
                    ></textarea>
                    <button id="send-text-btn" class="send-btn" aria-label="Send message">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                    <button id="speak-text-btn" class="speak-btn" aria-label="Speak message">
                        <img src="assets/speak.ico" alt="Speak" width="60" height="60">
                    </button>
                </div>

                <div class="control-buttons">
                    <button id="record-btn" class="control-btn record-btn">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                        <span>Start Recording</span>
                    </button>
                </div>
            </div>
        </main>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Voice Agent Settings</h2>
                    <button class="close-btn" id="close-settings">&times;</button>
                </div>
                
                <!-- Tab Navigation -->
                <div class="settings-tabs">
                    <button class="tab-btn active" data-tab="voice">Voice</button>
                    <button class="tab-btn" data-tab="recorder">Recorder</button>
                    <button class="tab-btn" data-tab="llm">LLM</button>
                    <button class="tab-btn" data-tab="system">System</button>
                </div>
                
                <div class="modal-body">
                    <!-- Voice Tab -->
                    <div id="voice-tab" class="tab-content active">
                        <div class="settings-section">
                            <h3>Text-to-Speech Settings</h3>
                            
                            <div class="setting-item horizontal-layout">
                                <div class="control-row">
                                    <label for="voice-select">Voice</label>
                                    <select id="voice-select" class="setting-control"></select>
                                </div>
                                <p class="setting-description">Choose the voice for text-to-speech output</p>
                            </div>
                            
                            <div class="setting-item horizontal-layout">
                                <div class="control-row">
                                    <label for="tts-model">Model</label>
                                    <select id="tts-model" class="setting-control">
                                        <option value="eleven_monolingual_v1">Eleven Monolingual v1</option>
                                        <option value="eleven_multilingual_v1">Eleven Multilingual v1</option>
                                        <option value="eleven_multilingual_v2" selected>Eleven Multilingual v2</option>
                                        <option value="eleven_turbo_v2">Eleven Turbo v2</option>
                                    </select>
                                </div>
                                <p class="setting-description">Select the TTS model - v2 models provide better quality</p>
                            </div>
                            
                            <div class="setting-item horizontal-layout">
                                <div class="control-row">
                                    <label for="output-quality">Output Quality</label>
                                    <select id="output-quality" class="setting-control">
                                        <option value="mp3_22050_32">Low (mp3 22kHz 32kbps)</option>
                                        <option value="mp3_44100_64">Medium (mp3 44kHz 64kbps)</option>
                                        <option value="mp3_44100_128">High (mp3 44kHz 128kbps)</option>
                                        <option value="mp3_44100_192" selected>Ultra (mp3 44kHz 192kbps)</option>
                                    </select>
                                </div>
                                <p class="setting-description">Higher quality means better audio but larger file sizes</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Stability (0-1)</span>
                                    <span class="value-display">0.5</span>
                                </div>
                                <input type="range" id="stability" min="0" max="1" step="0.05" value="0.5" class="setting-control">
                                <p class="setting-description">Higher values make speech more stable and consistent, lower values add expressiveness</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Similarity Boost (0-1)</span>
                                    <span class="value-display">0.75</span>
                                </div>
                                <input type="range" id="similarity-boost" min="0" max="1" step="0.05" value="0.75" class="setting-control">
                                <p class="setting-description">Higher values make output more similar to the original voice</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Speech Rate</span>
                                    <span class="value-display">1.0x</span>
                                </div>
                                <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1" class="setting-control">
                                <p class="setting-description">Adjust the speed of speech (0.5x = slower, 2x = faster)</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Style Exaggeration (0-1)</span>
                                    <span class="value-display">0.0</span>
                                </div>
                                <input type="range" id="style-exaggeration" min="0" max="1" step="0.05" value="0" class="setting-control">
                                <p class="setting-description">Exaggerate the style of the original voice (0 = no exaggeration)</p>
                            </div>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="speaker-boost" checked>
                                <span>Speaker Boost</span>
                            </label>
                            <p class="setting-description">Enhance clarity and reduce background artifacts</p>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="use-fixed-seed">
                                <span>Use Fixed Seed</span>
                            </label>
                            <p class="setting-description">Enable for consistent voice generation across requests</p>
                            
                            <div class="setting-item" id="fixed-seed-container" style="display: none;">
                                <label for="fixed-seed">Fixed Seed</label>
                                <input type="number" id="fixed-seed" class="setting-control" placeholder="Enter seed value" min="1" pattern="[0-9]+">
                                <p class="setting-description">Seed value for deterministic voice generation (must be > 0)</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recorder Tab -->
                    <div id="recorder-tab" class="tab-content">
                        <div class="settings-section">
                            <h3>Audio Recorder Settings (Silero VAD)</h3>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Positive Speech Threshold (0-1)</span>
                                    <span class="value-display">0.4</span>
                                </div>
                                <input type="range" id="positive-threshold" min="0" max="1" step="0.05" value="0.4" class="setting-control">
                                <p class="setting-description">Lower = more sensitive to speech. Default: 0.5</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Negative Speech Threshold (0-1)</span>
                                    <span class="value-display">0.55</span>
                                </div>
                                <input type="range" id="negative-threshold" min="0" max="1" step="0.05" value="0.55" class="setting-control">
                                <p class="setting-description">Lower = more likely to cut off speech. Default: 0.35</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Min Speech Frames (1-20)</span>
                                    <span class="value-display">8</span>
                                </div>
                                <input type="range" id="min-speech-frames" min="1" max="20" step="1" value="8" class="setting-control">
                                <p class="setting-description">Minimum consecutive speech frames to trigger. Default: 4</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Pre Speech Pad Frames (0-10)</span>
                                    <span class="value-display">3</span>
                                </div>
                                <input type="range" id="pre-speech-pad" min="0" max="10" step="1" value="3" class="setting-control">
                                <p class="setting-description">Frames to include before speech starts. Default: 1</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Redemption Frames (0-30)</span>
                                    <span class="value-display">30</span>
                                </div>
                                <input type="range" id="redemption-frames" min="0" max="30" step="1" value="30" class="setting-control">
                                <p class="setting-description">Frames of non-speech allowed before ending. Default: 8</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- LLM Tab -->
                    <div id="llm-tab" class="tab-content">
                        <div class="settings-section">
                            <h3>Language Model Settings</h3>
                            
                            <div class="setting-item">
                                <label for="llm-model">Model</label>
                                <select id="llm-model" class="setting-control">
                                    <option value="gpt-4-turbo-preview">GPT-4 Turbo</option>
                                    <option value="gpt-4">GPT-4</option>
                                    <option value="gpt-4-1106-preview">GPT-4 1106</option>
                                    <option value="gpt-4.1-mini" selected>GPT-4.1 Mini</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                                <p class="setting-description">Choose the AI model for generating responses</p>
                            </div>
                            
                            <div class="setting-item slider-group">
                                <div class="slider-label">
                                    <span>Temperature (0-1)</span>
                                    <span class="value-display">0.7</span>
                                </div>
                                <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="setting-control">
                                <p class="setting-description">Higher values make output more creative, lower values more focused</p>
                            </div>
                            
                            <div class="setting-item">
                                <label for="max-tokens">Max Tokens</label>
                                <input type="number" id="max-tokens" min="1" max="4294967295" value="150" class="setting-control" pattern="[0-9]+">
                                <p class="setting-description">Maximum length of generated responses (1 token ≈ 0.75 words)</p>
                            </div>
                            
                            <label class="checkbox-label">
                                <input type="checkbox" id="search-enabled" checked>
                                <span>Enable Internet Search</span>
                            </label>
                            <p class="setting-description">Allow AI to search the internet for current information</p>
                        </div>
                    </div>
                    
                    <!-- System Tab -->
                    <div id="system-tab" class="tab-content">
                        <div class="settings-section">
                            <h3>System Settings</h3>
                            
                            <div class="setting-item">
                                <label for="system-prompt">System Prompt</label>
                                <textarea id="system-prompt" rows="6" class="setting-control" 
                                        placeholder="Enter custom instructions for the AI assistant..."></textarea>
                                <p class="setting-description">Define how the AI assistant should behave and respond</p>
                            </div>
                            
                            <div class="horizontal-group">
                                <div class="setting-item slider-group">
                                    <div class="slider-label">
                                        <span>Eye Gaze Duration (seconds)</span>
                                        <span class="value-display">3.0s</span>
                                    </div>
                                    <input type="range" id="hover-duration" min="1" max="5" step="0.5" value="3" class="setting-control">
                                    <p class="setting-description">How long to look at an option before it's selected</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="visual-feedback" checked>
                                        <span>Eye Gaze Visual Feedback</span>
                                    </label>
                                </div>
                                
                                <div class="setting-item">
                                    <label for="default-language">Default Language</label>
                                    <select id="default-language" class="setting-control">
                                        <option value="en" selected>English</option>
                                        <option value="nl">Dutch (Nederlands)</option>
                                        <option value="es">Spanish (Español)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h3>RAG Settings</h3>
                            
                            <div class="rag-grid">
                                <div class="rag-labels">
                                    <label>Chunk Size</label>
                                    <label>Chunk Overlap</label>
                                    <label>Number of Results</label>
                                </div>
                                <div class="rag-inputs">
                                    <input type="number" id="chunk-size" min="100" max="2000" value="1000" class="setting-control" pattern="[0-9]+">
                                    <input type="number" id="chunk-overlap" min="0" max="500" value="200" class="setting-control" pattern="[0-9]+">
                                    <input type="number" id="top-k-results" min="1" max="20" value="5" class="setting-control" pattern="[0-9]+">
                                </div>
                                <p class="setting-description">Configure how documents are indexed and retrieved from the knowledge base. Chunk size determines text segment length, overlap maintains context between chunks, and number of results controls how many relevant documents are returned.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="save-btn" id="save-settings">Save Settings</button>
                </div>
            </div>
        </div>
        <!-- People Selection Modal -->
        <div id="peopleModal" class="modal">
            <div class="modal-content people-modal-content">
                <div class="modal-header">
                    <h2>People Management</h2>
                    <span class="close-modal" onclick="closePeopleModal()">&times;</span>
                </div>
                
                <div class="modal-body">
                    <div class="people-section">
                        <h3>Select a Person:</h3>
                        <div id="peopleGrid" class="people-grid">
                            <!-- People buttons will be dynamically loaded here -->
                        </div>
                    </div>
                    
                    <div class="edit-person-section" id="editPersonSection" style="display: none;">
                        <h3>Edit Person</h3>
                        <div class="edit-person-form">
                            <input type="text" 
                                   id="editPersonName" 
                                   placeholder="Person's name" 
                                   class="person-input">
                            <textarea id="editPersonNotes" 
                                      placeholder="Enter details about this person..." 
                                      class="person-textarea"></textarea>
                        </div>
                    </div>
                    
                    <div class="add-person-section" id="addPersonSection">
                        <h3>Add New Person</h3>
                        <div class="add-person-form">
                            <input type="text" 
                                   id="newPersonName" 
                                   placeholder="Person's name (e.g. John)" 
                                   class="person-input">
                            <textarea id="newPersonNotes" 
                                      placeholder="Enter details about this person..." 
                                      class="person-textarea"></textarea>
                        </div>
                    </div>
                    
                    <!-- Action buttons at bottom -->
                    <div id="personActions" class="person-actions">
                        <button onclick="saveOrUpdatePerson()" class="btn-primary action-btn" id="saveBtn">Save</button>
                        <button onclick="deletePerson()" class="btn-danger action-btn" id="deleteBtn" style="display: none;">Delete</button>
                        <button onclick="usePerson()" class="btn-success action-btn" id="useBtn" style="display: none;">Use</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- File Manager Modal - Add this to index.html after the People Modal -->
        <div id="fileManagerModal" class="modal">
            <div class="modal-content file-manager-modal-content">
                <div class="modal-header">
                    <h2>Knowledge Base Manager</h2>
                    <span class="close-modal" onclick="closeFileManager()">&times;</span>
                </div>
                
                <div class="file-manager-tabs">
                    <button class="tab-btn active" data-tab="files">Files</button>
                    <button class="tab-btn" data-tab="memories">Memories</button>
                </div>
                
                <div class="modal-body">
                    <!-- Files Tab -->
                    <div id="files-tab" class="tab-content active">
                        <div class="files-container">
                            <div class="files-header">
                                <div class="files-header-labels">
                                    <span>File Name</span>
                                    <span>Index</span>
                                </div>
                            </div>
                            
                            <div id="filesList" class="files-list">
                                <!-- Files will be dynamically loaded here -->
                            </div>
                            
                            <button id="loadMoreFilesBtn" class="load-more-btn" style="display: none;">Load More</button>
                        </div>
                        
                        <div class="files-bottom">
                            <div class="files-info">
                                <p>Supported: .txt, .pdf, .docx, .json, .md</p>
                                <p>Auto-indexed for AI assistance</p>
                            </div>
                            
                            <div class="file-actions">
                                <button id="deleteFilesBtn" class="action-btn btn-danger" disabled>Delete</button>
                                <button id="addFilesBtn" class="action-btn btn-success">Add</button>
                                <input type="file" id="fileUploadInput" multiple accept=".txt,.pdf,.docx,.json,.md" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Memories Tab -->
                    <div id="memories-tab" class="tab-content">
                        <div class="memories-container">
                            <div id="memoriesList" class="memories-list">
                                <!-- Memories will be dynamically loaded here -->
                            </div>
                            
                            <button id="loadMoreMemoriesBtn" class="load-more-btn" style="display: none;">Load More</button>
                        </div>
                        
                        <!-- Memory Form (hidden by default) -->
                        <div id="memoryForm" class="memory-form" style="display: none;">
                            <div class="form-row">
                                <input type="text" id="memoryTitle" placeholder="Title (e.g., Doctor's visit)" class="memory-input">
                                <input type="date" id="memoryDate" class="memory-input">
                            </div>
                            
                            <div class="form-row">
                                <input type="text" id="memoryTags" placeholder="Tags (separated by commas, e.g., medical, appointment)" class="memory-input full-width">
                            </div>
                            
                            <textarea id="memoryText" placeholder="Enter memory details here..." class="memory-textarea" rows="8"></textarea>
                            
                            <div class="form-actions">
                                <button id="cancelMemoryBtn" class="action-btn btn-secondary">Cancel</button>
                                <button id="saveMemoryBtn" class="action-btn btn-success">Save</button>
                            </div>
                        </div>
                        
                        <div id="memoryActions" class="memory-actions">
                            <button id="deleteMemoriesBtn" class="action-btn btn-danger" disabled>Delete</button>
                            <button id="editMemoryBtn" class="action-btn btn-primary" disabled>Edit</button>
                            <button id="addMemoryBtn" class="action-btn btn-success">Add</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Fallback to CDN if local socket.io fails
        if (typeof io === 'undefined') {
            document.write('<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"><\/script>');
        }
    </script>
    <script src="js/api.js"></script>
    <script src="js/audioRecorder.js"></script>
    <script src="js/eyeGazeControls.js"></script>
    <script src="js/conversationUI.js"></script>
    <script src="js/settingsUI.js"></script>
    <script src="js/peopleModal.js"></script>
    <script src="js/fileManager.js"></script> 
    <script src="js/main.js"></script>
</body>
</html>